<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Pengumuman</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-4">Tambah Pengumuman</h1>
  <form id="formAdd" class="space-y-4 max-w-lg bg-white p-4 rounded shadow">
    <input id="title" placeholder="Judul" class="w-full border px-3 py-2 rounded" required>
    <textarea id="body" placeholder="Isi pengumuman" class="w-full border px-3 py-2 rounded" required></textarea>
    <input id="date" type="date" class="w-full border px-3 py-2 rounded" required>
    <select id="category" class="w-full border px-3 py-2 rounded">
      <option value="layanan">Layanan</option>
      <option value="kegiatan">Kegiatan</option>
      <option value="kesehatan">Kesehatan</option>
    </select>

    <!-- Token -->
    <input id="token" type="password" placeholder="GitHub Token (hanya admin)" class="w-full border px-3 py-2 rounded" required>

    <div class="flex gap-3">
      <button class="px-4 py-2 bg-green-600 text-white rounded" type="submit">Simpan</button>
      <button type="button" id="btnLogout" class="px-4 py-2 bg-red-500 text-white rounded">Hapus Token</button>
    </div>
  </form>

  <script>
    const REPO_OWNER = "username";   // üîß ganti username GitHub kamu
    const REPO_NAME  = "repo-name";  // üîß ganti nama repo kamu
    const FILE_PATH  = "data/pengumuman.json";

    // === Load token dari localStorage kalau ada ===
    window.addEventListener("DOMContentLoaded", ()=>{
      const savedToken = localStorage.getItem("gh_token");
      if(savedToken){
        document.getElementById("token").value = savedToken;
      }
    });

    // === Logout (hapus token) ===
    document.getElementById("btnLogout").addEventListener("click", ()=>{
      localStorage.removeItem("gh_token");
      document.getElementById("token").value = "";
      alert("Token sudah dihapus dari browser.");
    });

    document.getElementById("formAdd").addEventListener("submit", async e=>{
      e.preventDefault();

      const token = document.getElementById("token").value;
      // simpan token ke localStorage
      localStorage.setItem("gh_token", token);

      const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`;

      try {
        // 1. Ambil file JSON lama
        const fileRes = await fetch(url, {
          headers: { Authorization: `token ${token}` }
        });
        if (!fileRes.ok) throw new Error("Gagal ambil file: " + fileRes.status);
        const fileData = await fileRes.json();
        const content = atob(fileData.content);
        let pengumuman = JSON.parse(content);

        // 2. Tambah item baru
        const newItem = {
          id: pengumuman.length ? Math.max(...pengumuman.map(p=>p.id))+1 : 1,
          title: document.getElementById("title").value,
          body: document.getElementById("body").value,
          date: document.getElementById("date").value,
          category: document.getElementById("category").value
        };
        pengumuman.push(newItem);

        // 3. Encode ke base64
        const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(pengumuman, null, 2))));

        // 4. Commit update ke GitHub
        const updateRes = await fetch(url, {
          method: "PUT",
          headers: {
            Authorization: `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: `Tambah pengumuman: ${newItem.title}`,
            content: updatedContent,
            sha: fileData.sha
          })
        });

        if (!updateRes.ok) throw new Error("Gagal update file: " + updateRes.status);
        alert("‚úÖ Pengumuman berhasil ditambahkan!");
        e.target.reset();

      } catch (err) {
        console.error(err);
        alert("‚ùå Error: " + err.message);
      }
    });
  </script>
</body>
</html>
