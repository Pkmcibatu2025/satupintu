<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Survei Kepuasan Masyarakat - UPT Puskesmas Cibatu (Aksesibel)</title>
<style>
  :root{
    --primary: #004d80;
    --accent: #ffb703;
    --bg: #f5f8fa;
    --card: #fff;
    --text: #122;
    --focus-color: #ffd23f;
  }
  body{margin:0;font-family:"Poppins",sans-serif;background:var(--bg);color:var(--text);transition:all .25s}
  header{background:var(--primary);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .logo{display:flex;gap:12px;align-items:center}
  .logo img{height:44px;border-radius:6px;background:#fff;padding:4px}
  .logo h1{margin:0;font-size:18px}
  nav{display:flex;gap:8px;align-items:center}
  .access-btn{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  .access-btn:focus{outline:3px solid var(--focus-color);outline-offset:3px}
  a.home{color:#fff;text-decoration:none;font-weight:600}
  main{max-width:1100px;margin:18px auto;padding:0 16px 80px}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,0.06);margin-bottom:16px}
  .hero{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
  .thumb{width:220px;height:120px;border-radius:10px;background:url('https://living-yellow-lmqwbafwtj.edgeone.app/Gambar%20WhatsApp%202025-05-28%20pukul%2014.15.57_fde8dd8e.jpg')center/cover;flex-shrink:0}
  h2{color:var(--primary);margin:0 0 8px}
  .controls {display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .controls button, .controls select {padding:8px 10px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
  .controls button:focus, button:focus, select:focus, input:focus, textarea:focus{outline:3px solid var(--focus-color);outline-offset:3px}
  form .section-title{font-weight:700;color:var(--primary);margin:18px 0 10px}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}
  label{display:block;margin-bottom:6px;font-weight:600}
  input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #bfc9d6;font-size:15px}
  textarea{min-height:110px;resize:vertical}
  .services-wrap{display:flex;flex-wrap:wrap;gap:8px}
  .radio-chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    background:#eef6ff;
    color:var(--primary);
    font-weight:700;
    cursor:pointer;
    border:1px solid transparent;
    user-select:none;
  }
  .radio-chip input[type="radio"]{display:none}
  .radio-chip[aria-checked="true"]{background:var(--primary);color:#fff;border-color:rgba(0,0,0,0.06)}
  .question{background:#fbfdff;padding:12px;border-radius:8px;border:1px solid #e6f0ff;margin-top:10px;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .q-left{flex:1}
  .q-actions{display:flex;gap:8px;align-items:center}
  .tts-btn{background:#fff;border:1px solid #cbd7e6;padding:8px;border-radius:8px;cursor:pointer}
  .tts-btn:focus{outline:3px solid var(--focus-color);outline-offset:2px}
  .reading {box-shadow:0 0 0 4px rgba(255, 203, 79, 0.18);border-color:var(--focus-color)}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px;flex-wrap:wrap}
  .primary{background:var(--primary);color:#fff;border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700}
  .secondary{background:#fff;border:1px solid #bfc9d6;padding:10px 14px;border-radius:10px;cursor:pointer}
  .toast{position:fixed;right:18px;bottom:18px;background:#063;color:#fff;padding:12px 16px;border-radius:10px;display:none;z-index:9999;min-width:220px;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
  .toast.show{display:block;animation:toastShow .36s ease}
  .toast.success{background:#28a745}
  .toast.error{background:#d9534f}
  @keyframes toastShow{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
  body.access-mode{--primary:#001f3f;--bg:#f3f4f6;--text:#000;font-size:1.15em}
  body.access-mode input, body.access-mode select, body.access-mode textarea{border:2px solid #000}
  body.access-mode .radio-chip{background:#fff;border:2px solid #001f3f}
  body.access-mode .radio-chip[aria-checked="true"]{background:#001f3f;color:#fff}
  body.access-mode .question{border:2px solid #000;background:#fff}
  body.access-mode .tts-btn{border:2px solid #000;background:#fff}
  .q-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
  .q-row label{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:8px;
    border:1px solid #e1e6ee;
    margin:0;
    cursor:pointer;
    user-select:none;
    font-weight:600;
  }
  .q-row input[type="radio"]{width:22px;height:22px;flex:0 0 auto}
  .q-row label[aria-checked="true"]{background:rgba(0,77,128,0.08);border-color:rgba(0,77,128,0.2)}
  @media (max-width:480px){
    .q-row label{flex:1;justify-content:center;padding:12px 10px}
    .q-row{gap:10px}
  }
  @media (max-width:768px){
    .hero{flex-direction:column}
    .thumb{width:100%;height:160px}
    .actions{flex-direction:column-reverse}
    .controls{justify-content:flex-start}
  }
</style>
</head>
<body>
<header>
  <div class="logo">
    <img src="https://pkmcibatu2025.github.io/satupintu/FDGD.png" alt="logo puskesmas" />
    <div>
      <h1>UPT Puskesmas Cibatu</h1>
      <div style="font-size:13px;opacity:.9">Dinas Kesehatan Kab. Garut</div>
    </div>
  </div>

  <nav>
    <a class="home" href="https://pkmcibatu2025.github.io/satupintu/pengaduan.html" aria-label="Kembali ke halaman pengaduan">üè† Beranda</a>
    <div style="width:8px"></div>
    <div class="controls" role="region" aria-label="Kontrol aksesibilitas">
      <button id="toggleAccess" class="access-btn" aria-pressed="false" aria-label="Aktifkan mode aksesibilitas">‚ôø Mode Aksesibilitas</button>
      <button id="readAll" title="Baca semua pertanyaan" aria-hidden="true" style="display:none;margin-left:6px" type="button">üîä Baca Semua</button>
      <label for="langSelect" id="langLabel" style="margin-left:6px;display:none;color:#fff;font-weight:700">Bahasa:</label>
      <select id="langSelect" aria-label="Pilih bahasa TTS" style="display:none">
        <option value="id-ID">Bahasa Indonesia</option>
        <option value="en-US">English</option>
      </select>
    </div>
  </nav>
</header>

<main>
  <div class="card hero" aria-hidden="true">
    <div>
      <h2>Survei Kepuasan Masyarakat (IKM)</h2>
      <p>Terima kasih telah meluangkan waktu. Jawaban Anda membantu kami meningkatkan mutu pelayanan.</p>
      <small>Durasi ¬±2‚Äì5 menit ‚Ä¢ Skala 1‚Äì4</small>
    </div>
    <div class="thumb" aria-hidden="true"></div>
  </div>

  <form id="ikmForm" class="card" aria-label="Form Survei IKM" autocomplete="off">
    <div class="section-title">A. Data Responden</div>
    <div class="grid" role="group" aria-label="Data responden">
      <div>
        <label for="res_number">Nama Pasien</label>
        <input id="res_number" name="res_number" required aria-required="true" aria-label="Nama pasien" placeholder="Nama lengkap">
      </div>

      <div>
        <label for="age">Umur (Tahun)</label>
        <input id="age" name="age" type="number" min="1" required aria-required="true" aria-label="Umur">
      </div>

      <div>
        <label for="gender">Jenis Kelamin</label>
        <select id="gender" name="gender" required aria-required="true" aria-label="Jenis kelamin">
          <option value="">Pilih...</option>
          <option>Laki-laki</option>
          <option>Perempuan</option>
        </select>
      </div>

      <div>
        <label for="education">Pendidikan Terakhir</label>
        <select id="education" name="education" required aria-required="true" aria-label="Pendidikan terakhir">
          <option value="">Pilih...</option>
          <option>SD ke Bawah</option>
          <option>SLTP / Sederajat</option>
          <option>SLTA / Sederajat</option>
          <option>D1-D4</option>
          <option>S-1</option>
          <option>S-2 ke Atas</option>
        </select>
      </div>

      <div>
        <label for="job">Pekerjaan Utama</label>
        <select id="job" name="job" required aria-required="true" aria-label="Pekerjaan utama">
          <option value="">Pilih...</option>
          <option>Pimpinan Perusahaan</option>
          <option>Wiraswasta</option>
          <option>PNS/TNI/Polri</option>
          <option>Karyawan Swasta</option>
          <option>Ibu Rumah Tangga</option>
          <option>Pelajar/Mahasiswa</option>
          <option>Tidak Bekerja</option>
        </select>
      </div>
    </div>

    <div style="margin-top:14px">
      <label>Jenis Layanan (pilih satu)</label>
      <div class="services-wrap" role="radiogroup" aria-label="Jenis layanan">
        <label class="radio-chip" role="radio" aria-checked="false" tabindex="0">
          <input type="radio" name="service_radio" value="Pendaftaran">
          Pendaftaran
        </label>
        <label class="radio-chip" role="radio" aria-checked="false" tabindex="0">
          <input type="radio" name="service_radio" value="Kasir">
          Kasir
        </label>
        <label class="radio-chip" role="radio" aria-checked="false" tabindex="0">
          <input type="radio" name="service_radio" value="Pelayanan Usia Produktif">
          Usia Produktif / Dewasa
        </label>
        <label class="radio-chip" role="radio" aria-checked="false" tabindex="0">
          <input type="radio" name="service_radio" value="KB">
          KB
        </label>
        <label class="radio-chip" role="radio" aria-checked="false" tabindex="0">
          <input type="radio" name="service_radio" value="Gigi">
          Gigi dan Mulut
        </label>
        <label class="radio-chip" role="radio" aria-checked="false" tabindex="0">
          <input type="radio" name="service_radio" value="KIA">
          Kesehatan Ibu & Anak
        </label>
        <label class="radio-chip" role="radio" aria-checked="false" tabindex="0">
          <input type="radio" name="service_radio" value="Lansia">
          Lansia
        </label>
        <label class="radio-chip" role="radio" aria-checked="false" tabindex="0">
          <input type="radio" name="service_radio" value="Apotek">
          Apotek
        </label>
        <label class="radio-chip" role="radio" aria-checked="false" tabindex="0">
          <input type="radio" name="service_radio" value="UGD">
          UGD
        </label>
        <label class="radio-chip" role="radio" aria-checked="false" tabindex="0">
          <input type="radio" name="service_radio" value="Rawat Inap">
          Rawat Inap
        </label>
        <label class="radio-chip" role="radio" aria-checked="false" tabindex="0">
          <input type="radio" name="service_radio" value="Laboratorium">
          Laboratorium
        </label>
        <label class="radio-chip" role="radio" aria-checked="false" tabindex="0">
          <input type="radio" name="service_radio" value="PUSTU">
          PUSTU
        </label>
      </div>
      <input id="service_other" name="service_other" placeholder="Jika lain-lain, tulis di sini" style="margin-top:8px">
    </div>

    <hr style="margin:18px 0;border:none;border-top:1px solid #eef6ff">

    <div class="section-title">B. Data Alamat</div>
    <div class="grid" role="group" aria-label="Data alamat">
      <div style="grid-column:1/-1">
        <label for="surveyor_name">Alamat Lengkap</label>
        <textarea id="surveyor_name" name="surveyor_name" required aria-required="true" aria-label="Alamat lengkap" placeholder="Tuliskan alamat lengkap"></textarea>
      </div>

      <div>
        <label for="surveyor_nip">Pilih Desa</label>
        <select id="surveyor_nip" name="surveyor_nip" required aria-required="true" aria-label="Pilih desa">
          <option value="">Pilih Desa...</option>
          <option>Cibatu</option>
          <option>Kertajaya</option>
          <option>Wanakerta</option>
          <option>Keresek</option>
          <option>Padasuka</option>
          <option>Cibunar</option>
          <option>Sindangsuka</option>
          <option>Mekarsari</option>
          <option>Karyamukti</option>
          <option>Sukalilah</option>
          <option>Girimukti</option>
        </select>
      </div>

      <div>
        <label for="survey_date">Tanggal Survei</label>
        <input id="survey_date" name="survey_date" type="date" required aria-required="true">
      </div>

      <div>
        <label for="survey_time">Jam Survei</label>
        <select id="survey_time" name="survey_time" required aria-required="true">
          <option value="">Pilih...</option>
          <option>07.30 ‚Äì 14.30</option>
          <option>14.30 ‚Äì 19.30</option>
          <option>19.30 ‚Äì 07.30</option>
        </select>
      </div>
    </div>

    <hr style="margin:18px 0;border:none;border-top:1px solid #eef6ff">

    <div class="section-title">C. Pendapat Responden</div>
    <div id="questions" role="list"></div>

    <div style="margin-top:12px">
      <label for="suggestion">Saran / Masukan</label>
      <textarea id="suggestion" name="suggestion" required aria-required="true" placeholder="Tuliskan saran Anda di sini"></textarea>
    </div>

    <div class="actions">
      <button type="button" class="secondary" id="resetBtn">Reset</button>
      <button type="submit" class="primary" id="submitBtn">Kirim Jawaban</button>
    </div>
  </form>
</main>

<div class="toast" id="toast" role="status" aria-live="polite">Terkirim ‚Äî Terima kasih!</div>

<script>
/* ------------------- konfigurasi ------------------- */
/* ganti WEBAPP_URL sesuai deployment Apps Script mu */
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzAmkmX6fHmG61iDUxXkVGWAKxHljb1Qo2wg0Vb-_auFGKQUTLPqkwmsONKESaf30w/exec";

/* ------------------- pertanyaan ------------------- */
const pertanyaan = [
  "Kesesuaian persyaratan pelayanan dengan jenis pelayanannya",
  "Kemampuan petugas dalam memberikan pelayanan",
  "Kemudahan prosedur pelayanan",
  "Perilaku petugas (kesopanan & keramahan)",
  "Kecepatan waktu dalam memberikan pelayanan",
  "Penanganan pengaduan pengguna layanan",
  "Kewajaran biaya/tarif dalam pelayanan",
  "Kualitas sarana dan prasarana",
  "Kesesuaian produk pelayanan dengan standar pelayanan"
];

const pertanyaan_en = [
  "Suitability of required documents and conditions for the service",
  "Staff capability in providing the service",
  "Ease of the service procedure",
  "Staff behaviour (politeness and friendliness)",
  "Speed of service delivery",
  "Handling of complaints from service users",
  "Reasonableness of fees/charges in service",
  "Quality of facilities and infrastructure",
  "Suitability of the service product with the service standard"
];

const qContainer = document.getElementById('questions');
pertanyaan.forEach((text, idx) => {
  const i = idx + 1;
  const q = document.createElement('div');
  q.className = 'question';
  q.setAttribute('role','listitem');
  q.innerHTML = `
    <div class="q-left">
      <p style="margin:0 0 6px;font-weight:700">${i}. ${text}</p>
      <div class="q-row" role="radiogroup" aria-label="Pertanyaan ${i}">
        <label aria-checked="false"><input required name="q${i}" type="radio" value="1"> 1</label>
        <label aria-checked="false"><input name="q${i}" type="radio" value="2"> 2</label>
        <label aria-checked="false"><input name="q${i}" type="radio" value="3"> 3</label>
        <label aria-checked="false"><input name="q${i}" type="radio" value="4"> 4</label>
      </div>
    </div>
    <div class="q-actions" aria-hidden="true">
      <button type="button" class="tts-btn" data-q="${i}" title="Baca pertanyaan ${i}" aria-label="Baca pertanyaan ${i}">üîä</button>
    </div>
  `;
  qContainer.appendChild(q);
});

/* ------------------- TTS (speechSynthesis) ------------------- */
let synth = window.speechSynthesis;
let availableVoices = [];

function refreshVoices(){
  if(!synth) return;
  availableVoices = synth.getVoices() || [];
  // sometimes voices load asynchronously; keep simple guarantee
  if(!availableVoices.length){
    setTimeout(()=>{ availableVoices = synth.getVoices() || []; }, 300);
  }
}
if(typeof speechSynthesis !== 'undefined'){
  refreshVoices();
  speechSynthesis.onvoiceschanged = refreshVoices;
}

function getVoiceForLang(langCode){
  if(!availableVoices.length) refreshVoices();
  const primary = (langCode || '').toLowerCase();
  if(!primary) return null;
  let v = availableVoices.find(voice => voice.lang && voice.lang.toLowerCase().startsWith(primary));
  if(v) return v;
  const part = primary.split('-')[0];
  v = availableVoices.find(voice => voice.lang && voice.lang.toLowerCase().startsWith(part));
  if(v) return v;
  v = availableVoices.find(voice => /google|microsoft/i.test(voice.name));
  return v || availableVoices[0] || null;
}

function speak(text, lang='id-ID', onstart=null, onend=null){
  if(!synth) return;
  // if no voices yet, try short delay then speak
  if(!availableVoices.length){
    refreshVoices();
    setTimeout(()=> speak(text, lang, onstart, onend), 250);
    return;
  }
  try { synth.cancel(); } catch(e){}
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang;
  const voice = getVoiceForLang(lang);
  if(voice) u.voice = voice;
  u.rate = 1;
  if(onstart) u.onstart = onstart;
  if(onend) u.onend = onend;
  try { synth.speak(u); } catch(e) { if(onend) onend(); }
}

function getReadText(idx, lang){
  const language = (lang || 'id-ID').toLowerCase();
  if(language.startsWith('en')){
    const q = pertanyaan_en[idx-1] || pertanyaan[idx-1];
    return `${idx}. ${q}. Choose a rating from 1 to 4.`;
  } else {
    const q = pertanyaan[idx-1];
    return `${idx}. ${q}. Pilih nilai 1 sampai 4.`;
  }
}

/* ------------------- Accessibility UI ------------------- */
const toggleAccess = document.getElementById('toggleAccess');
const readAllBtn = document.getElementById('readAll');
const langSelect = document.getElementById('langSelect');
const langLabel = document.getElementById('langLabel');

function updateAccessUI(active){
  document.body.classList.toggle('access-mode', active);
  toggleAccess.setAttribute('aria-pressed', String(active));
  toggleAccess.textContent = active ? "‚òÄÔ∏è Mode Normal" : "‚ôø Mode Aksesibilitas";
  readAllBtn.style.display = active ? 'inline-block' : 'none';
  langSelect.style.display = active ? 'inline-block' : 'none';
  langLabel.style.display = active ? 'inline-block' : 'none';

  // q-actions buttons
  document.querySelectorAll('.q-actions').forEach(qact=>{
    const btn = qact.querySelector('.tts-btn');
    if(active){
      qact.setAttribute('aria-hidden','false');
      if(btn){
        btn.style.display = 'inline-block';
        btn.disabled = false;
        btn.removeAttribute('aria-hidden');
        btn.setAttribute('tabindex','0');
        btn.style.pointerEvents = 'auto';
      }
    } else {
      qact.setAttribute('aria-hidden','true');
      if(btn){
        btn.style.display = 'none';
        btn.disabled = true;
        btn.setAttribute('aria-hidden','true');
        btn.setAttribute('tabindex','-1');
        btn.style.pointerEvents = 'none';
        const qEl = qact.closest('.question');
        if(qEl) qEl.classList.remove('reading');
      }
    }
  });

  if(!active && synth && synth.speaking){ try { synth.cancel(); } catch(e){} }
}
updateAccessUI(false);

toggleAccess.addEventListener('click', () => {
  const active = !document.body.classList.contains('access-mode');
  updateAccessUI(active);
});
toggleAccess.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); toggleAccess.click(); } });

/* ------------------- Event delegation for per-question TTS ------------------- */
/* Using delegation guarantees buttons always respond (even if created dynamically) */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest && e.target.closest('.tts-btn');
  if(!btn) return;
  // only respond if access mode aktif
  if(!document.body.classList.contains('access-mode')) return;
  const idx = parseInt(btn.dataset.q, 10);
  if(!idx) return;
  const qEl = btn.closest('.question');
  const lang = langSelect.value || 'id-ID';
  const text = getReadText(idx, lang);
  if(qEl) qEl.classList.add('reading');
  speak(text, lang, null, ()=>{ if(qEl) qEl.classList.remove('reading'); });
  // focus first radio so keyboard users can continue input
  const firstRadio = qEl && qEl.querySelector('input[type="radio"]');
  if(firstRadio) firstRadio.focus();
});

/* keyboard activation for tts buttons (space/enter) */
document.addEventListener('keydown', (e)=>{
  const el = document.activeElement;
  if(!el) return;
  if(el.classList && el.classList.contains('tts-btn') && (e.key==='Enter' || e.key===' ')){
    e.preventDefault();
    el.click();
  }
});

/* read all questions sequentially */
async function readAllQuestions(){
  if(!document.body.classList.contains('access-mode')) return;
  readAllBtn.disabled = true;
  const lang = langSelect.value || 'id-ID';
  for(let i=0;i<pertanyaan.length;i++){
    const idx = i+1;
    const qEl = document.querySelector(`.tts-btn[data-q="${idx}"]`)?.closest('.question');
    if(qEl) qEl.classList.add('reading');
    await new Promise(resolve=>{
      speak(getReadText(idx, lang), lang, null, ()=>{ if(qEl) qEl.classList.remove('reading'); setTimeout(resolve, 300); });
    });
  }
  readAllBtn.disabled = false;
}
readAllBtn.addEventListener('click', readAllQuestions);
langSelect.addEventListener('change', ()=>{ langSelect.blur(); });

/* ------------------- radio-chip interactions ------------------- */
document.querySelectorAll('.radio-chip').forEach(lbl=>{
  const radio = lbl.querySelector('input[type="radio"]');
  lbl.addEventListener('click', ()=>{
    if(radio.disabled) return;
    radio.checked = true;
    document.querySelectorAll('.radio-chip').forEach(x=> x.setAttribute('aria-checked','false'));
    lbl.setAttribute('aria-checked','true');
    document.getElementById('service_other').value = '';
  });
  lbl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); lbl.click(); }
  });
});
document.getElementById('service_other').addEventListener('input', (e)=>{
  if(e.target.value && e.target.value.trim().length){
    document.querySelectorAll('.radio-chip input[type="radio"]').forEach(r=> r.checked = false);
    document.querySelectorAll('.radio-chip').forEach(x=> x.setAttribute('aria-checked','false'));
  }
});

/* update aria-checked on radios for q-row */
document.addEventListener('change', (e)=>{
  if(e.target && e.target.type === 'radio' && e.target.name && e.target.name.startsWith('q')){
    const name = e.target.name;
    const radios = document.querySelectorAll(`input[name="${name}"]`);
    radios.forEach(r => {
      const lbl = r.closest('label') || r.parentElement;
      if(lbl && lbl.tagName.toLowerCase() === 'label'){
        lbl.setAttribute('aria-checked', r.checked ? 'true' : 'false');
      }
    });
  }
});

/* ------------------- reset ------------------- */
document.getElementById('resetBtn').addEventListener('click', ()=>{
  const form = document.getElementById('ikmForm');
  form.reset();
  document.querySelectorAll('.radio-chip').forEach(x=> x.setAttribute('aria-checked','false'));
  document.querySelectorAll('.q-row label').forEach(lbl=> lbl.setAttribute('aria-checked','false'));
});

/* ------------------- toast ------------------- */
function showToast(message, type='success'){
  const t = document.getElementById('toast');
  t.textContent = message;
  t.className = `toast ${type} show`;
  setTimeout(()=>{ t.classList.remove('show'); }, 3600);
}

/* ------------------- submit (POST JSON) ------------------- */
document.getElementById('ikmForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true; submitBtn.textContent = 'Mengirim...';

  const form = ev.target;
  const fm = new FormData(form);
  const data = Object.fromEntries(fm.entries());

  // choose service
  const chosenRadio = document.querySelector('.radio-chip input[type="radio"]:checked');
  if(chosenRadio) data.services = chosenRadio.value;
  else data.services = (data.service_other && data.service_other.trim()) ? data.service_other.trim() : '';

  data.timestamp = new Date().toISOString();

  // collect q1..q9
  pertanyaan.forEach((_,i)=>{
    const qName = `q${i+1}`;
    const el = form.querySelector(`input[name="${qName}"]:checked`);
    data[qName] = el ? el.value : '';
  });

  // validate answers
  const allQAnswered = pertanyaan.every((_,i) => !!form.querySelector(`input[name="q${i+1}"]:checked`));
  if(!allQAnswered){
    showToast('Mohon isi semua pertanyaan (skala 1-4).', 'error');
    submitBtn.disabled = false; submitBtn.textContent = 'Kirim Jawaban';
    return;
  }

  // POST JSON (expect Apps Script doPost to parse JSON)
  try{
    const resp = await fetch(WEBAPP_URL, {
      method: 'POST',
      mode: "no-cors",
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });

    let resJson = null;
    try { resJson = await resp.clone().json(); } catch(e){ resJson = null; }

    if(resp.ok && (resJson === null || resJson.status === 'success' || resJson.result === 'success' || resJson.status === 'ok')){
      showToast('‚úÖ Data berhasil dikirim!', 'success');
      form.reset();
      document.querySelectorAll('.radio-chip').forEach(x=> x.setAttribute('aria-checked','false'));
      document.querySelectorAll('.q-row label').forEach(lbl=> lbl.setAttribute('aria-checked','false'));
    } else {
      const msg = resJson && (resJson.message || resJson.error) ? (resJson.message || resJson.error) : resp.statusText || 'Gagal mengirim data';
      showToast('Gagal mengirim data: ' + msg, 'error');
      console.warn('Response not OK', resp.status, resJson);
    }
  } catch(err){
    console.warn('Primary POST failed', err);
    showToast('‚ùå Gagal mengirim data. Periksa koneksi atau konfigurasi Apps Script.', 'error');
  } finally {
    submitBtn.disabled = false; submitBtn.textContent = 'Kirim Jawaban';
  }
});

/* keyboard shortcut: Ctrl+M toggles access mode */
document.addEventListener('keydown', (e)=>{
  if(e.ctrlKey && e.key.toLowerCase() === 'm'){
    document.getElementById('toggleAccess').click();
  }
});
</script>
</body>
</html>
